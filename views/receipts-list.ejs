<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Receipts Management</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>
  <body>
    <div class="container-fluid py-4">
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0"><i class="fas fa-receipt me-2"></i> Fee Receipts</h4>
        </div>
        <div class="card-body">
          <table id="receiptsTable" class="table table-hover">
            <thead>
              <tr>
                <th>Receipt #</th>
                <th>Student</th>
                <th>Amount</th>
                <th>Date</th>
                <th>Category</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

    <script>
      $(document).ready(function () {
        const table = $("#receiptsTable").DataTable({
          ajax: {
            url: "/fees/all-receipts",
            dataSrc: "receipts",
          },
          columns: [
            { data: "receipt_number" },
            {
              data: null,
              render: function (data) {
                return `${data.first_name} ${data.last_name}`;
              },
            },
            {
              data: "amount_paid",
              render: function (data) {
                return "KSh " + parseFloat(data).toLocaleString();
              },
            },
            {
              data: "payment_date",
              render: function (data) {
                return new Date(data).toLocaleDateString();
              },
            },
            { data: "fee_type" },
            {
              data: "status",
              render: function (data) {
                const badgeClass =
                  data === "Paid"
                    ? "bg-success"
                    : data === "Partial"
                      ? "bg-warning"
                      : "bg-danger";
                return `<span class="badge ${badgeClass}">${data}</span>`;
              },
            },
            {
              data: null,
              render: function (data) {
                return `
                                <div class="btn-group">
                                    <a href="/fees/receipt/${data.receipt_number}" 
                                       class="btn btn-sm btn-primary" target="_blank">
                                        <i class="fas fa-print"></i> Print
                                    </a>
                                    <a href="/fees/receipt/${data.receipt_number}?download=1" 
                                       class="btn btn-sm btn-success">
                                        <i class="fas fa-download"></i> PDF
                                    </a>
                                </div>
                            `;
              },
            },
          ],
        });
      });
      // GET /fees/all-receipts - Get all receipts for DataTable
      router.get("/all-receipts", async (req, res) => {
        try {
          const receipts = await dbAll(`
            SELECT 
                f.*,
                s.first_name,
                s.last_name,
                s.admission_number
            FROM fees f
            LEFT JOIN students s ON f.student_id = s.id
            ORDER BY f.payment_date DESC
            LIMIT 100
        `);

          res.json({
            success: true,
            receipts: receipts,
            count: receipts.length,
          });
        } catch (error) {
          console.error("Error fetching all receipts:", error);
          res.status(500).json({
            success: false,
            message: "Failed to fetch receipts",
          });
        }
      });

      // GET /fees/receipts-page - Render receipts list page
      router.get("/receipts-page", async (req, res) => {
        try {
          res.render("receipts-list", {
            title: "Receipts Management",
            user: req.session.user || null,
          });
        } catch (error) {
          console.error("Error rendering receipts page:", error);
          res.status(500).send("Error loading page");
        }
      });
    </script>
  </body>
</html>
