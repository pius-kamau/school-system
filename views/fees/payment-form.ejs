<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Record Payment - School System</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- jQuery (for AJAX) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Custom CSS for Payment Form -->
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --warning: #f72585;
            --info: #7209b7;
        }

        .card-header.bg-gradient-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary)) !important;
        }

        .quick-amount-btn {
            transition: all 0.2s;
            border-radius: 20px !important;
            margin: 2px;
        }

        .quick-amount-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .fee-summary-card {
            border-radius: 10px;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .fee-summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .border-danger {
            border-color: #dc3545 !important;
        }

        .border-success {
            border-color: #28a745 !important;
        }

        .border-warning {
            border-color: #ffc107 !important;
        }

        .border-info {
            border-color: #17a2b8 !important;
        }

        .receipt-input {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            letter-spacing: 1px;
            font-size: 1.1rem;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
        }

        .student-info-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-left: 4px solid var(--primary);
        }

        .amount-input-group {
            position: relative;
        }

        .amount-input-group .input-group-text {
            background-color: var(--primary);
            color: white;
            font-weight: bold;
            border-color: var(--primary);
        }

        #submitPayment:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Recent payments table */
        .recent-payments-table tbody tr {
            transition: all 0.2s;
        }

        .recent-payments-table tbody tr:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }

        /* Status badges */
        .badge-paid {
            background-color: #28a745;
            color: white;
        }

        .badge-pending {
            background-color: #ffc107;
            color: #212529;
        }

        .badge-partial {
            background-color: #17a2b8;
            color: white;
        }
    </style>
</head>

<body>
    <div class="container-fluid py-3">
        <div class="row">
            <div class="col-12">
                <!-- Header Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-0">
                                <i class="fas fa-money-bill-wave me-2"></i>Record Fee Payment
                            </h5>
                            <small class="opacity-75">Complete the form below to record a new payment</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-light text-dark fs-6 px-3 py-2">
                                <i class="fas fa-receipt me-1"></i>Receipt: #<%= nextReceiptNumber %>
                            </span>
                            <div class="text-white mt-1">
                                <small>
                                    <%= new Date().toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Left Column - Payment Form -->
                    <div class="col-lg-8">
                        <div class="card shadow-sm mb-4">
                            <div class="card-body">
                                <!-- Student Selection -->
                                <div class="mb-4">
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-user-graduate me-2"></i>Step 1: Select Student
                                    </h6>

                                    <div class="row g-2 mb-3">
                                        <div class="col-md-8">
                                            <div class="input-group">
                                                <span class="input-group-text bg-primary text-white">
                                                    <i class="fas fa-search"></i>
                                                </span>
                                                <select class="form-select" id="studentSelect" required>
                                                    <option value="">-- Select a student --</option>
                                                    <!-- Students will be loaded via AJAX -->
                                                </select>
                                            </div>
                                            <small class="text-muted mt-1 d-block">Select student from the list</small>
                                        </div>
                                        <div class="col-md-4">
                                            <button class="btn btn-outline-primary w-100 h-100" id="refreshStudents" type="button">
                                                <i class="fas fa-sync-alt me-1"></i>Refresh List
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Selected Student Info -->
                                    <div class="card student-info-card mb-3 d-none" id="studentInfoCard">
                                        <div class="card-body py-3">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="mb-1 text-primary" id="studentName"></h6>
                                                    <p class="text-muted mb-1" id="studentDetails"></p>
                                                    <small class="text-muted" id="studentContact"></small>
                                                </div>
                                                <button type="button" class="btn btn-sm btn-outline-danger" id="changeStudent">
                                                    <i class="fas fa-times me-1"></i>Change
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Fee Category Selection -->
                                <div class="mb-3">
                                    <label for="categoryId" class="form-label fw-bold">
                                        <i class="fas fa-tags me-1"></i>Fee Category *
                                    </label>
                                    <select class="form-control" id="categoryId" name="categoryId" required>
                                        <option value="">Select Fee Type</option>
                                        <!-- Options will be loaded via JavaScript -->
                                    </select>
                                    <small class="text-muted">Select the type of fee being paid</small>
                                </div>

                                <!-- Fee Summary (Hidden until student selected) -->
                                <div class="row g-3 mb-4 d-none" id="feeSummary">
                                    <div class="col-12">
                                        <h6 class="text-primary mb-3">
                                            <i class="fas fa-calculator me-2"></i>Fee Summary
                                        </h6>
                                    </div>
                                    <div class="col-md-3 col-sm-6">
                                        <div class="card fee-summary-card border-danger h-100">
                                            <div class="card-body text-center p-3">
                                                <i class="fas fa-file-invoice-dollar fa-2x text-danger mb-2"></i>
                                                <h6 class="text-muted mb-2">Total Fee</h6>
                                                <h4 id="totalFee" class="text-danger fw-bold mb-0">KSH 0</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-sm-6">
                                        <div class="card fee-summary-card border-success h-100">
                                            <div class="card-body text-center p-3">
                                                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                                                <h6 class="text-muted mb-2">Already Paid</h6>
                                                <h4 id="paidAmount" class="text-success fw-bold mb-0">KSH 0</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-sm-6">
                                        <div class="card fee-summary-card border-warning h-100">
                                            <div class="card-body text-center p-3">
                                                <i class="fas fa-balance-scale fa-2x text-warning mb-2"></i>
                                                <h6 class="text-muted mb-2">Balance</h6>
                                                <h4 id="balanceAmount" class="text-warning fw-bold mb-0">KSH 0</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3 col-sm-6">
                                        <div class="card fee-summary-card border-info h-100">
                                            <div class="card-body text-center p-3">
                                                <i class="fas fa-money-check-alt fa-2x text-info mb-2"></i>
                                                <h6 class="text-muted mb-2">This Payment</h6>
                                                <h4 id="paymentAmount" class="text-info fw-bold mb-0">KSH 0</h4>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Payment Form -->
                                <form id="paymentForm" class="needs-validation" novalidate>
                                    <h6 class="text-primary mb-3">
                                        <i class="fas fa-credit-card me-2"></i>Step 2: Payment Details
                                    </h6>

                                    <div class="row g-3">
                                        <!-- Student ID (Hidden) -->
                                        <input type="hidden" name="studentId" id="studentId">

                                        <!-- Receipt Number -->
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">
                                                <i class="fas fa-receipt me-1"></i>Receipt Number *
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text bg-light">#</span>
                                                <input type="text" class="form-control receipt-input" name="receiptNumber" id="receiptNumber" value="<%= nextReceiptNumber %>" required readonly>
                                                <button type="button" class="btn btn-outline-primary" id="generateReceipt">
                                                    <i class="fas fa-redo me-1"></i> New
                                                </button>
                                            </div>
                                            <small class="text-muted">Auto-generated receipt number</small>
                                        </div>

                                        <!-- Payment Date -->
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">
                                                <i class="fas fa-calendar-alt me-1"></i>Payment Date *
                                            </label>
                                            <input type="date" class="form-control" name="paymentDate" id="paymentDate" value="<%= new Date().toISOString().split('T')[0] %>" required>
                                        </div>

                                        <!-- Payment Amount -->
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">
                                                <i class="fas fa-money-bill-wave me-1"></i>Payment Amount (KSH) *
                                            </label>
                                            <div class="input-group amount-input-group">
                                                <span class="input-group-text">KSH</span>
                                                <input type="number" class="form-control" name="amount" id="amount" min="100" step="100" required placeholder="Enter amount" disabled>
                                            </div>
                                            <div class="mt-2">
                                                <small class="text-muted d-block mb-1">Quick amounts:</small>
                                                <div class="d-flex flex-wrap gap-2">
                                                    <% [500, 1000, 2000, 5000, 10000, 20000, 50000].forEach(amt=> { %>
                                                        <button type="button" class="btn btn-sm btn-outline-primary quick-amount-btn" data-amount="<%= amt %>">
                                                            <%= amt.toLocaleString() %>
                                                        </button>
                                                    <% }) %>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Payment Method -->
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">
                                                <i class="fas fa-credit-card me-1"></i>Payment Method *
                                            </label>
                                            <select class="form-select" name="paymentMethod" id="paymentMethod" required>
                                                <option value="">Select Method</option>
                                                <option value="Cash">Cash</option>
                                                <option value="MPesa">MPesa</option>
                                                <option value="Bank Transfer">Bank Transfer</option>
                                                <option value="Cheque">Cheque</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>

                                        <!-- Term (REQUIRED) -->
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">
                                                <i class="fas fa-calendar me-1"></i>Term *
                                            </label>
                                            <select class="form-control" id="term" name="term" required>
                                                <option value="">Select Term</option>
                                                <option value="Term 1">Term 1</option>
                                                <option value="Term 2">Term 2</option>
                                                <option value="Term 3">Term 3</option>
                                            </select>
                                        </div>

                                        <!-- Academic Year -->
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">
                                                <i class="fas fa-calendar-alt me-1"></i>Academic Year
                                            </label>
                                            <input type="text" class="form-control" id="academicYear" name="academicYear" value="2024" placeholder="e.g., 2024">
                                        </div>

                                        <!-- Payment Method Details (Conditional) -->
                                        <div class="col-12">
                                            <div id="mpesaDetails" class="conditional-details" style="display: none;">
                                                <div class="card border-primary">
                                                    <div class="card-body">
                                                        <h6 class="text-primary">
                                                            <i class="fas fa-mobile-alt me-2"></i>MPesa Details
                                                        </h6>
                                                        <div class="row g-3 mt-2">
                                                            <div class="col-md-6">
                                                                <label class="form-label">MPesa Transaction Code</label>
                                                                <input type="text" class="form-control" name="mpesaCode" id="mpesaCode" placeholder="e.g., RFT67G8901">
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label class="form-label">Phone Number</label>
                                                                <input type="text" class="form-control" name="phoneNumber" id="phoneNumber" placeholder="07XX XXX XXX">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div id="bankDetails" class="conditional-details" style="display: none;">
                                                <div class="card border-primary">
                                                    <div class="card-body">
                                                        <h6 class="text-primary">
                                                            <i class="fas fa-university me-2"></i>Bank Transfer Details
                                                        </h6>
                                                        <div class="row g-3 mt-2">
                                                            <div class="col-md-6">
                                                                <label class="form-label">Bank Name</label>
                                                                <input type="text" class="form-control" name="bankName" id="bankName" placeholder="e.g., Equity Bank">
                                                            </div>
                                                            <div class="col-md-6">
                                                                <label class="form-label">Reference Number</label>
                                                                <input type="text" class="form-control" name="bankReference" id="bankReference" placeholder="Transaction reference">
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Notes -->
                                        <div class="col-12">
                                            <label class="form-label fw-bold">
                                                <i class="fas fa-sticky-note me-1"></i>Payment Notes (Optional)
                                            </label>
                                            <textarea class="form-control" name="notes" id="notes" rows="2" placeholder="Add any notes about this payment..."></textarea>
                                        </div>

                                        <!-- Action Buttons -->
                                        <div class="col-12 mt-4 pt-3 border-top">
                                            <div class="d-flex justify-content-end gap-2">
                                                <button type="button" class="btn btn-outline-secondary px-4" id="cancelPayment">
                                                    <i class="fas fa-times me-1"></i>Cancel
                                                </button>
                                                <button type="submit" class="btn btn-success px-4" id="submitPayment" disabled>
                                                    <i class="fas fa-check-circle me-2"></i>Record Payment
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column - Recent Payments & Stats -->
                    <div class="col-lg-4">
                        <!-- Today's Payments Card -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-history me-2"></i>Today's Payments
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <div id="recentPaymentsContainer" class="p-3">
                                    <div class="text-center py-5">
                                        <div class="spinner mx-auto mb-3"></div>
                                        <p class="text-muted mb-0">Loading recent payments...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-light">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <small class="text-muted d-block">Today's Total</small>
                                        <span class="fw-bold text-success" id="todayTotal">KSH 0</span>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block">Payments Count</small>
                                        <span class="fw-bold text-primary" id="paymentsCount">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Stats Card -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-line me-2"></i>Quick Stats
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="text-muted">Monthly Collection</span>
                                    <span class="fw-bold text-primary" id="monthlyTotal">KSH 0</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="text-muted">Pending Students</span>
                                    <span class="fw-bold text-warning" id="pendingCount">0</span>
                                </div>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar bg-success" id="collectionProgress" style="width: 0%"></div>
                                </div>
                                <small class="text-muted">Collection progress this month</small>
                            </div>
                        </div>

                        <!-- Outstanding Balances Card -->
                        <div class="card shadow-sm">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-exclamation-triangle me-2"></i>Outstanding Balances
                                </h6>
                            </div>
                            <div class="card-body p-0">
                                <div id="outstandingBalancesContainer" class="p-3">
                                    <div class="text-center py-5">
                                        <div class="spinner mx-auto mb-3"></div>
                                        <p class="text-muted mb-0">Loading outstanding balances...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Payment Form JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Payment form loaded');

            // Elements
            const studentSelect = document.getElementById('studentSelect');
            const categorySelect = document.getElementById('categoryId');
            const amountInput = document.getElementById('amount');
            const receiptNumberInput = document.getElementById('receiptNumber');
            const submitBtn = document.getElementById('submitPayment');
            const paymentForm = document.getElementById('paymentForm');
            const recentPaymentsContainer = document.getElementById('recentPaymentsContainer');
            const outstandingBalancesContainer = document.getElementById('outstandingBalancesContainer');
            const termSelect = document.getElementById('term');

            // Load initial data
            loadStudents();
            loadFeeCategories();
            loadRecentPayments();
            loadOutstandingBalances();
            loadQuickStats();

            // Load fee categories
            function loadFeeCategories() {
                console.log('Loading fee categories...');
                
                fetch('/fees/categories/active')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Categories response:', data);
                        
                        if (data.success && data.categories) {
                            // Clear and populate dropdown
                            categorySelect.innerHTML = '<option value="">Select Fee Type</option>';
                            
                            data.categories.forEach(category => {
                                const option = document.createElement('option');
                                option.value = category.id;
                                const amount = category.default_amount ? 
                                    ` (KSh ${parseFloat(category.default_amount).toLocaleString()})` : 
                                    '';
                                option.textContent = `${category.name}${amount}`;
                                categorySelect.appendChild(option);
                            });
                            
                            console.log(`Loaded ${data.categories.length} fee categories`);
                            
                            // If there's only one category, select it by default
                            if (data.categories.length === 1) {
                                categorySelect.value = data.categories[0].id;
                            }
                        } else {
                            console.error('Failed to load categories:', data);
                            categorySelect.innerHTML = '<option value="">Error loading categories</option>';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading categories:', error);
                        categorySelect.innerHTML = '<option value="">Error: Could not load categories</option>';
                    });
            }

            // Load students - FIXED: No dummy data
            function loadStudents() {
                console.log('Loading students...');
                
                // Show loading state
                studentSelect.innerHTML = '<option value="">Loading students...</option>';
                
                fetch('/fees/students/all')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Server error: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(students => {
                        console.log(`Loaded ${students.length} students from database`);
                        
                        // Clear and populate dropdown
                        studentSelect.innerHTML = '<option value="">-- Select a student --</option>';
                        
                        if (students.length === 0) {
                            // Show message if no students
                            studentSelect.innerHTML = `
                                <option value="">No active students found</option>
                                <option value="" disabled>Please add students to the database first</option>
                            `;
                            console.warn('No students found in database');
                            return;
                        }
                        
                        students.forEach(student => {
                            const option = document.createElement('option');
                            option.value = student.id;
                            option.textContent = `${student.name} - ${student.class} (${student.admission_number})`;
                            option.dataset.fee = student.fee_amount || 15000;
                            option.dataset.firstName = student.first_name;
                            option.dataset.lastName = student.last_name;
                            option.dataset.parentPhone = student.parent_phone || '';
                            studentSelect.appendChild(option);
                        });
                        
                        console.log(`Successfully loaded ${students.length} students`);
                        
                    })
                    .catch(error => {
                        console.error('Error loading students:', error);
                        studentSelect.innerHTML = `
                            <option value="">Error loading students</option>
                            <option value="" disabled>Error: ${error.message}</option>
                            <option value="" disabled>Please check database connection</option>
                        `;
                    });
            }

            // Load recent payments
            function loadRecentPayments() {
                console.log('Loading recent payments...');
                
                fetch('/fees/recent-payments')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.payments && data.payments.length > 0) {
                            const html = `
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Receipt</th>
                                                <th>Student</th>
                                                <th>Amount</th>
                                                <th>Time</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.payments.map(payment => `
                                                <tr>
                                                    <td>#${payment.receipt_number || 'N/A'}</td>
                                                    <td>${payment.student_name || 'Unknown'}</td>
                                                    <td class="text-success fw-bold">KSH ${(payment.amount_paid || 0).toLocaleString()}</td>
                                                    <td>
                                                        <small class="text-muted">
                                                            ${payment.created_at ?
                                                                new Date(payment.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                                                                : 'N/A'}
                                                        </small>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted">Total today: <strong>KSH ${(data.total || 0).toLocaleString()}</strong></small>
                                </div>
                            `;
                            recentPaymentsContainer.innerHTML = html;
                            
                            // Update counts
                            document.getElementById('todayTotal').textContent = `KSH ${(data.total || 0).toLocaleString()}`;
                            document.getElementById('paymentsCount').textContent = data.count || 0;
                        } else {
                            recentPaymentsContainer.innerHTML = `
                                <div class="text-center py-4">
                                    <i class="fas fa-money-bill-wave fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">No payments recorded today</p>
                                </div>
                            `;
                            // Reset counts
                            document.getElementById('todayTotal').textContent = 'KSH 0';
                            document.getElementById('paymentsCount').textContent = '0';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading recent payments:', error);
                        recentPaymentsContainer.innerHTML = `
                            <div class="text-center py-4">
                                <i class="fas fa-exclamation-triangle fa-3x text-muted mb-3"></i>
                                <p class="text-muted">Could not load recent payments</p>
                            </div>
                        `;
                        // Reset counts
                        document.getElementById('todayTotal').textContent = 'KSH 0';
                        document.getElementById('paymentsCount').textContent = '0';
                    });
            }

            // Load outstanding balances
            function loadOutstandingBalances() {
                console.log('Loading outstanding balances...');
                
                fetch('/fees/outstanding-data')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.outstanding && data.outstanding.length > 0) {
                            const html = `
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Student</th>
                                                <th>Class</th>
                                                <th>Balance</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.outstanding.slice(0, 5).map(student => `
                                                <tr>
                                                    <td>${student.name || 'Unknown'}</td>
                                                    <td>${student.class || '-'}</td>
                                                    <td class="text-danger fw-bold">KSH ${(student.balance || 0).toLocaleString()}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                ${data.outstanding.length > 5 ? 
                                    `<div class="text-center mt-2">
                                        <small class="text-muted">+${data.outstanding.length - 5} more students</small>
                                    </div>` 
                                    : ''}
                            `;
                            outstandingBalancesContainer.innerHTML = html;
                        } else {
                            outstandingBalancesContainer.innerHTML = `
                                <div class="text-center py-4">
                                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                    <p class="text-muted">No outstanding balances</p>
                                    <small class="text-muted">All fees are paid</small>
                                </div>
                            `;
                        }
                    })
                    .catch(error => {
                        console.error('Error loading outstanding balances:', error);
                        outstandingBalancesContainer.innerHTML = `
                            <div class="text-center py-4">
                                <i class="fas fa-exclamation-triangle fa-3x text-muted mb-3"></i>
                                <p class="text-muted">Could not load outstanding balances</p>
                            </div>
                        `;
                    });
            }

            // Load quick stats
            function loadQuickStats() {
                console.log('Loading quick stats...');
                
                // Get monthly total from server data passed from backend
                const monthlyTotal = <%= typeof monthlyTotal !== 'undefined' ? monthlyTotal : 0 %>;
                const pendingCount = <%= typeof pendingCount !== 'undefined' ? pendingCount : 0 %>;
                
                document.getElementById('monthlyTotal').textContent = `KSH ${monthlyTotal.toLocaleString()}`;
                document.getElementById('pendingCount').textContent = pendingCount;
                
                // Calculate progress (assuming target of 500,000 for demo)
                const target = 500000;
                const progress = Math.min(100, (monthlyTotal / target) * 100);
                document.getElementById('collectionProgress').style.width = `${progress}%`;
            }

            // Student selection handler
            studentSelect.addEventListener('change', function () {
                const studentId = this.value;

                if (!studentId) {
                    // No student selected
                    amountInput.disabled = true;
                    amountInput.value = '';
                    submitBtn.disabled = true;
                    hideFeeSummary();
                    hideStudentInfo();
                    return;
                }

                // Student selected - enable amount field
                amountInput.disabled = false;
                amountInput.focus();
                submitBtn.disabled = false;

                // Get selected option data
                const selectedOption = this.options[this.selectedIndex];
                const feeAmount = parseFloat(selectedOption.dataset.fee) || 15000;

                // Set hidden studentId field
                document.getElementById('studentId').value = studentId;

                // Show student info
                showStudentInfo(selectedOption);

                // Show fee summary
                showFeeSummary(feeAmount);

                console.log(`Student selected: ${selectedOption.textContent}, Fee: ${feeAmount}`);
            });

            // Show student info
            function showStudentInfo(selectedOption) {
                const firstName = selectedOption.dataset.firstName || '';
                const lastName = selectedOption.dataset.lastName || '';
                const parentPhone = selectedOption.dataset.parentPhone || '';
                
                document.getElementById('studentName').textContent = `${firstName} ${lastName}`;
                document.getElementById('studentDetails').textContent = selectedOption.textContent;
                document.getElementById('studentContact').textContent = parentPhone ? `Phone: ${parentPhone}` : '';
                
                document.getElementById('studentInfoCard').classList.remove('d-none');
            }

            // Hide student info
            function hideStudentInfo() {
                document.getElementById('studentInfoCard').classList.add('d-none');
            }

            // Show fee summary
            function showFeeSummary(totalFee) {
                // Update UI with fee information
                document.getElementById('totalFee').textContent = `KSH ${totalFee.toLocaleString()}`;
                document.getElementById('paymentAmount').textContent = `KSH 0`;

                // Show the fee summary section
                document.getElementById('feeSummary').classList.remove('d-none');
            }

            // Hide fee summary
            function hideFeeSummary() {
                document.getElementById('feeSummary').classList.add('d-none');
            }

            // Change student button
            document.getElementById('changeStudent').addEventListener('click', function () {
                studentSelect.value = '';
                studentSelect.dispatchEvent(new Event('change'));
                studentSelect.focus();
            });

            // Refresh students button
            document.getElementById('refreshStudents').addEventListener('click', function () {
                loadStudents();
            });

            // Quick amount buttons
            document.querySelectorAll('.quick-amount-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const amount = parseInt(this.dataset.amount);
                    amountInput.value = amount;
                    updatePaymentAmountDisplay(amount);

                    // Enable submit button if category is selected
                    submitBtn.disabled = !categorySelect.value;
                });
            });

            // Amount input handler
            amountInput.addEventListener('input', function () {
                const amount = parseFloat(this.value) || 0;
                updatePaymentAmountDisplay(amount);

                // Enable/disable submit button based on amount and category
                submitBtn.disabled = amount <= 0 || !categorySelect.value;
            });

            // Category selection handler
            categorySelect.addEventListener('change', function () {
                // Enable/disable submit button based on category selection
                const hasStudent = studentSelect.value;
                const hasAmount = parseFloat(amountInput.value) > 0;
                const hasCategory = this.value;
                
                submitBtn.disabled = !hasStudent || !hasAmount || !hasCategory;
            });

            // Update payment amount display
            function updatePaymentAmountDisplay(amount) {
                document.getElementById('paymentAmount').textContent = `KSH ${amount.toLocaleString()}`;

                // Validate amount doesn't exceed total fee
                const totalFee = parseFloat(document.getElementById('totalFee').textContent.replace(/[^0-9.]/g, '')) || 0;
                if (amount > totalFee) {
                    amountInput.classList.add('is-invalid');
                    submitBtn.disabled = true;
                } else {
                    amountInput.classList.remove('is-invalid');
                    
                    // Also check if category is selected
                    const hasCategory = categorySelect.value;
                    submitBtn.disabled = !hasCategory;
                }
            }

            // Generate new receipt
            document.getElementById('generateReceipt').addEventListener('click', function () {
                const current = parseInt(receiptNumberInput.value) || 0;
                receiptNumberInput.value = (current + 1).toString().padStart(4, '0');
            });

            // Payment method change - show/hide details
            document.getElementById('paymentMethod').addEventListener('change', function () {
                const method = this.value;

                // Hide all detail sections
                document.querySelectorAll('.conditional-details').forEach(el => {
                    el.style.display = 'none';
                });

                // Show selected method's details
                if (method === 'MPesa') {
                    document.getElementById('mpesaDetails').style.display = 'block';
                } else if (method === 'Bank Transfer') {
                    document.getElementById('bankDetails').style.display = 'block';
                }
            });

            // Form submission
            paymentForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                // Collect all form data
                const formData = {
                    studentId: document.getElementById('studentId').value,
                    receiptNumber: document.getElementById('receiptNumber').value,
                    amount: document.getElementById('amount').value,
                    paymentDate: document.getElementById('paymentDate').value,
                    paymentMethod: document.getElementById('paymentMethod').value,
                    term: document.getElementById('term').value,
                    academicYear: document.getElementById('academicYear').value || '2024',
                    categoryId: document.getElementById('categoryId').value,
                    notes: document.getElementById('notes').value || '',
                    mpesaCode: document.getElementById('mpesaCode')?.value || '',
                    phoneNumber: document.getElementById('phoneNumber')?.value || '',
                    bankName: document.getElementById('bankName')?.value || '',
                    bankReference: document.getElementById('bankReference')?.value || ''
                };

                console.log(' Form data to send:', formData);

                // Validate required fields
                const missingFields = [];
                if (!formData.studentId) missingFields.push('Student');
                if (!formData.receiptNumber) missingFields.push('Receipt Number');
                if (!formData.amount) missingFields.push('Amount');
                if (!formData.paymentDate) missingFields.push('Payment Date');
                if (!formData.paymentMethod) missingFields.push('Payment Method');
                if (!formData.term) missingFields.push('Term');
                if (!formData.categoryId) missingFields.push('Fee Category');

                if (missingFields.length > 0) {
                    alert('Please fill all required fields: ' + missingFields.join(', '));
                    return;
                }

                // Validate amount is a number
                if (isNaN(parseFloat(formData.amount)) || parseFloat(formData.amount) <= 0) {
                    alert('Please enter a valid amount');
                    amountInput.focus();
                    return;
                }

                // Show confirmation
                const studentName = studentSelect.options[studentSelect.selectedIndex].textContent.split(' - ')[0];
                const categoryName = categorySelect.options[categorySelect.selectedIndex].textContent.split(' (')[0];
                const confirmMessage = `Confirm payment of KSH ${parseFloat(formData.amount).toLocaleString()} for ${studentName} (${categoryName})?`;

                if (!confirm(confirmMessage)) {
                    return;
                }

                // Disable form and show loading
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

                try {
                    console.log(' Sending POST request to /fees/payments...');

                    const response = await fetch('/fees/payments', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    console.log(' Response status:', response.status);

                    const result = await response.json();
                    console.log(' Response data:', result);

                    if (result.success) {
                        // Ask user if they want to view/print receipt
                        const printReceipt = confirm(` Payment recorded successfully!\n\nReceipt: #${result.receiptNumber}\nAmount: KSH ${result.amount.toLocaleString()}\nCategory: ${result.category}\n\nDo you want to view/print the receipt?`);
                        
                        if (printReceipt) {
                            // Open receipt in new tab
                            window.open(`/fees/receipt/${result.receiptNumber}`, '_blank');
                        }

                        // Reset form
                        paymentForm.reset();
                        studentSelect.value = '';
                        amountInput.disabled = true;
                        submitBtn.disabled = true;
                        hideFeeSummary();
                        hideStudentInfo();
                        
                        // Reset category
                        categorySelect.value = '';

                        // Update receipt number
                        const current = parseInt(receiptNumberInput.value) || 0;
                        receiptNumberInput.value = (current + 1).toString().padStart(4, '0');

                        // Reset date to today
                        document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
                        document.getElementById('academicYear').value = '2024';

                        // Reload data
                        loadRecentPayments();
                        loadOutstandingBalances();
                        loadQuickStats();
                        loadFeeCategories();

                        // Re-enable button
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Record Payment';

                    } else {
                        // Error from server
                        alert(` Error: ${result.message || 'Payment failed'}`);
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Record Payment';
                    }

                } catch (error) {
                    console.error('Payment submission error:', error);
                    alert(' Network error. Please check your connection and try again.');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Record Payment';
                }
            });

            // Cancel button
            document.getElementById('cancelPayment').addEventListener('click', function () {
                if (confirm('Cancel this payment? All entered data will be lost.')) {
                    paymentForm.reset();
                    studentSelect.value = '';
                    categorySelect.value = '';
                    amountInput.disabled = true;
                    submitBtn.disabled = true;
                    hideFeeSummary();
                    hideStudentInfo();
                    document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
                    document.getElementById('academicYear').value = '2024';
                }
            });
        });
    </script>
</body>
</html>