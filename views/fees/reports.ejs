<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fee Reports & Analytics</title>
    <!-- FONT AWESOME CDN -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <!-- CHART.JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Mono:wght@400;500&display=swap");

      :root {
        --primary: #4361ee;
        --primary-dark: #3a0ca3;
        --secondary: #7209b7;
        --success: #4cc9f0;
        --success-dark: #4895ef;
        --danger: #f72585;
        --warning: #f8961e;
        --info: #2a9d8f;
        --dark: #2b2d42;
        --light: #f8f9fa;
        --gray: #6c757d;
        --light-gray: #e9ecef;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
      }

      body {
        background-color: #f5f7fa;
        color: var(--dark);
        min-height: 100vh;
      }

      /* Navigation */
      .navbar {
        background: var(--dark);
        color: white;
        padding: 15px 0;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
      }

      .nav-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .nav-brand {
        font-size: 22px;
        font-weight: 600;
        color: white;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .nav-links {
        display: flex;
        gap: 15px;
        align-items: center;
      }

      .nav-link {
        color: rgba(255, 255, 255, 0.9);
        text-decoration: none;
        padding: 8px 15px;
        border-radius: 6px;
        transition: all 0.3s;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .nav-link:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }

      .nav-link.active {
        background: var(--primary);
        color: white;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 5px 15px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        font-size: 14px;
      }

      /* Main Container */
      .container {
        max-width: 1400px;
        margin: 30px auto;
        padding: 0 20px;
      }

      /* Header */
      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid var(--light-gray);
      }

      .page-title {
        font-size: 28px;
        font-weight: 700;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .header-actions {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      /* Report Cards Grid */
      .reports-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
      }

      .report-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s;
        border: 2px solid transparent;
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }

      .report-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        border-color: var(--primary);
      }

      .report-card.active {
        border-color: var(--primary);
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      }

      .report-icon {
        font-size: 40px;
        color: var(--primary);
        margin-bottom: 20px;
        width: 70px;
        height: 70px;
        background: rgba(67, 97, 238, 0.1);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .report-title {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 10px;
        color: var(--dark);
      }

      .report-desc {
        color: var(--gray);
        font-size: 14px;
        line-height: 1.5;
        margin-bottom: 20px;
      }

      .report-stats {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid var(--light-gray);
      }

      .stat-badge {
        background: var(--primary);
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      /* Filters Section */
      .filters-section {
        background: white;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
      }

      .section-title {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 25px;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--dark);
        font-size: 14px;
      }

      .form-control {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid var(--light-gray);
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s;
        background: white;
      }

      .form-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
      }

      .form-control.select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%234361ee' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 15px center;
        background-size: 12px;
        padding-right: 40px;
      }

      /* Results Section */
      .results-section {
        background: white;
        border-radius: 12px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        min-height: 400px;
      }

      /* Loading State */
      .loading-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--gray);
      }

      .loading-icon {
        font-size: 40px;
        margin-bottom: 20px;
        color: var(--primary);
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--gray);
      }

      .empty-icon {
        font-size: 60px;
        margin-bottom: 20px;
        opacity: 0.3;
      }

      .empty-state h3 {
        font-size: 22px;
        font-weight: 700;
        margin-bottom: 10px;
        color: var(--dark);
      }

      .empty-state p {
        font-size: 15px;
        max-width: 500px;
        margin: 0 auto 25px;
        line-height: 1.6;
      }

      /* Buttons */
      .btn {
        padding: 12px 25px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
      }

      .btn-primary {
        background: var(--primary);
        color: white;
      }

      .btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
      }

      .btn-secondary {
        background: var(--light-gray);
        color: var(--dark);
      }

      .btn-secondary:hover {
        background: #dee2e6;
        transform: translateY(-2px);
      }

      .btn-success {
        background: var(--success-dark);
        color: white;
      }

      .btn-success:hover {
        background: #3a86ff;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(72, 149, 239, 0.3);
      }

      .btn-danger {
        background: var(--danger);
        color: white;
      }

      .btn-danger:hover {
        background: #e11575;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(247, 37, 133, 0.3);
      }

      .btn-outline {
        background: transparent;
        border: 2px solid var(--primary);
        color: var(--primary);
      }

      .btn-outline:hover {
        background: var(--primary);
        color: white;
      }

      .btn-sm {
        padding: 8px 15px;
        font-size: 13px;
      }

      .btn-block {
        width: 100%;
        justify-content: center;
      }

      /* Charts Container - COMPACT */
      .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .chart-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        height: 300px; /* Fixed height */
        display: flex;
        flex-direction: column;
      }

      .chart-title {
        font-size: 16px;
        font-weight: 700;
        margin-bottom: 15px;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 10px;
        flex-shrink: 0;
      }

      .chart-wrapper {
        flex: 1;
        position: relative;
        min-height: 200px;
      }

      /* Data Table */
      .data-table-container {
        overflow-x: auto;
        border-radius: 8px;
        border: 1px solid var(--light-gray);
        margin-top: 20px;
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px;
      }

      .data-table thead {
        background: var(--dark);
      }

      .data-table th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: white;
        font-size: 14px;
        white-space: nowrap;
      }

      .data-table td {
        padding: 15px;
        border-bottom: 1px solid var(--light-gray);
        vertical-align: middle;
        font-size: 14px;
      }

      .data-table tbody tr:hover {
        background: #f8f9fa;
      }

      .data-table tbody tr:last-child td {
        border-bottom: none;
      }

      /* Summary Cards */
      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .summary-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        text-align: center;
        border-top: 4px solid var(--primary);
      }

      .summary-card.total {
        border-top-color: var(--success-dark);
      }

      .summary-card.paid {
        border-top-color: var(--success);
      }

      .summary-card.balance {
        border-top-color: var(--warning);
      }

      .summary-card.count {
        border-top-color: var(--info);
      }

      .summary-value {
        font-size: 22px;
        font-weight: 700;
        margin: 8px 0;
        color: var(--dark);
      }

      .summary-label {
        color: var(--gray);
        font-size: 13px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      /* Export Options */
      .export-options {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      /* Alerts */
      .alert {
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
        animation: fadeIn 0.3s;
      }

      .alert.show {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .alert-success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }

      .alert-error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }

      .alert-warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
      }

      /* Footer */
      .footer {
        text-align: center;
        color: var(--gray);
        font-size: 14px;
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid var(--light-gray);
      }

      /* Animation */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Responsive */
      @media (max-width: 768px) {
        .reports-grid {
          grid-template-columns: 1fr;
        }

        .charts-grid {
          grid-template-columns: 1fr;
        }

        .chart-container {
          height: 280px;
          padding: 15px;
        }

        .nav-links {
          flex-wrap: wrap;
          justify-content: center;
        }

        .page-header {
          flex-direction: column;
          gap: 15px;
          align-items: flex-start;
        }

        .header-actions {
          width: 100%;
          justify-content: flex-start;
        }
      }

      /* Badge */
      .badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .badge-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #15572422;
      }

      .badge-warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #85640422;
      }

      .badge-danger {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #721c2422;
      }

      .badge-info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #0c546022;
      }

      /* Status Colors */
      .status-paid {
        color: var(--success);
      }
      .status-partial {
        color: var(--warning);
      }
      .status-pending {
        color: var(--danger);
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar">
      <div class="nav-container">
        <a href="/" class="nav-brand">
          <i class="fas fa-school"></i>
          School Management System
        </a>
        <div class="nav-links">
          <a href="/dashboard" class="nav-link">
            <i class="fas fa-home"></i> Dashboard
          </a>
          <a href="/fees" class="nav-link">
            <i class="fas fa-money-bill-wave"></i> Fees
          </a>
          <a href="/fees/reports" class="nav-link active">
            <i class="fas fa-chart-bar"></i> Reports
          </a>
          <a href="/fees/backup" class="nav-link">
            <i class="fas fa-database"></i> Backup
          </a>
          <div class="user-info">
            <span><%= user.username %></span>
            <span>(<%= user.role %>)</span>
          </div>
          <a href="/logout" class="nav-link">
            <i class="fas fa-sign-out-alt"></i> Logout
          </a>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
      <!-- Header -->
      <div class="page-header">
        <h1 class="page-title">
          <i class="fas fa-chart-bar"></i>
          Fee Reports & Analytics
        </h1>
        <div class="header-actions">
          <button id="exportAllBtn" class="btn btn-success">
            <i class="fas fa-file-export"></i> Export All
          </button>
          <a href="/fees" class="btn btn-outline">
            <i class="fas fa-arrow-left"></i> Back to Fees
          </a>
        </div>
      </div>

      <!-- Alerts -->
      <div id="successAlert" class="alert alert-success">
        <i class="fas fa-check-circle"></i> <span id="successMessage"></span>
      </div>

      <div id="errorAlert" class="alert alert-error">
        <i class="fas fa-exclamation-circle"></i>
        <span id="errorMessage"></span>
      </div>

      <!-- Report Type Selection -->
      <div class="reports-grid" id="reportTypes">
        <!-- Report cards will be loaded here -->
      </div>

      <!-- Filters Section -->
      <div class="filters-section" id="filtersSection" style="display: none">
        <h3 class="section-title">
          <i class="fas fa-filter"></i>
          Report Filters
        </h3>

        <div class="filters-grid">
          <div class="form-group">
            <label class="form-label">Date Range</label>
            <select id="dateRange" class="form-control select">
              <option value="today">Today</option>
              <option value="yesterday">Yesterday</option>
              <option value="this_week">This Week</option>
              <option value="last_week">Last Week</option>
              <option value="this_month">This Month</option>
              <option value="last_month">Last Month</option>
              <option value="this_year">This Year</option>
              <option value="last_year">Last Year</option>
              <option value="custom">Custom Range</option>
              <option value="all">All Time</option>
            </select>
          </div>

          <div class="form-group" id="customDateRange" style="display: none">
            <label class="form-label">Custom Dates</label>
            <div style="display: flex; gap: 10px">
              <input
                type="date"
                id="startDate"
                class="form-control"
                style="flex: 1"
              />
              <input
                type="date"
                id="endDate"
                class="form-control"
                style="flex: 1"
              />
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Academic Year</label>
            <select id="academicYear" class="form-control select">
              <option value="all">All Years</option>
              <!-- Options will be populated by JavaScript -->
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Term</label>
            <select id="term" class="form-control select">
              <option value="all">All Terms</option>
              <option value="Term 1">Term 1</option>
              <option value="Term 2">Term 2</option>
              <option value="Term 3">Term 3</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Fee Category</label>
            <select id="feeCategory" class="form-control select">
              <option value="all">All Categories</option>
              <!-- Options will be populated by JavaScript -->
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Payment Status</label>
            <select id="paymentStatus" class="form-control select">
              <option value="all">All Statuses</option>
              <option value="paid">Paid</option>
              <option value="partial">Partial</option>
              <option value="pending">Pending</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Payment Method</label>
            <select id="paymentMethod" class="form-control select">
              <option value="all">All Methods</option>
              <option value="Cash">Cash</option>
              <option value="MPesa">MPesa</option>
              <option value="Bank Transfer">Bank Transfer</option>
              <option value="Cheque">Cheque</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Class/Form</label>
            <select id="studentClass" class="form-control select">
              <option value="all">All Classes</option>
              <!-- Options will be populated by JavaScript -->
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Sort By</label>
            <select id="sortBy" class="form-control select">
              <option value="date_desc">Date (Newest First)</option>
              <option value="date_asc">Date (Oldest First)</option>
              <option value="amount_desc">Amount (High to Low)</option>
              <option value="amount_asc">Amount (Low to High)</option>
              <option value="student_asc">Student (A-Z)</option>
              <option value="student_desc">Student (Z-A)</option>
            </select>
          </div>
        </div>

        <div style="display: flex; gap: 10px">
          <button id="generateReportBtn" class="btn btn-primary btn-block">
            <i class="fas fa-play"></i> Generate Report
          </button>
          <button id="resetFiltersBtn" class="btn btn-secondary">
            <i class="fas fa-redo"></i> Reset
          </button>
        </div>
      </div>

      <!-- Results Section -->
      <div class="results-section" id="resultsSection" style="display: none">
        <div id="reportLoading" class="loading-state" style="display: none">
          <div class="loading-icon">
            <i class="fas fa-spinner fa-spin"></i>
          </div>
          <h3>Generating Report...</h3>
          <p>Please wait while we process your data</p>
        </div>

        <div id="reportEmpty" class="empty-state" style="display: none">
          <div class="empty-icon">
            <i class="fas fa-chart-line"></i>
          </div>
          <h3>No Data Found</h3>
          <p>
            No records match your filter criteria. Try adjusting your filters.
          </p>
          <button id="adjustFiltersBtn" class="btn btn-primary">
            <i class="fas fa-filter"></i> Adjust Filters
          </button>
        </div>

        <div id="reportContent" style="display: none">
          <!-- Report content will be loaded here -->
        </div>
      </div>

      <!-- Footer -->
      <div class="footer">
        <p>
          Fee Reports System • Generated on: <span id="currentDate"></span> •
          Total Records: <span id="totalRecords">0</span>
        </p>
      </div>
    </div>

    <!-- Templates -->
    <template id="reportCardTemplate">
      <div class="report-card" data-report-type="">
        <div class="report-icon">
          <i class="fas"></i>
        </div>
        <h3 class="report-title"></h3>
        <p class="report-desc"></p>
        <div class="report-stats">
          <span class="stat-badge">Generate</span>
          <span class="last-generated"></span>
        </div>
      </div>
    </template>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Set current date in footer
        document.getElementById("currentDate").textContent =
          new Date().toLocaleDateString("en-GB", {
            day: "2-digit",
            month: "long",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });

        // Initialize the reports system
        initializeReports();
        setupEventListeners();
      });

      // Report Types Configuration
      const reportTypes = [
        {
          id: "daily_collection",
          title: "Daily Collection Report",
          description:
            "Detailed breakdown of daily fee collections with category-wise analysis",
          icon: "fa-calendar-day",
          color: "#4361ee",
        },
        {
          id: "monthly_summary",
          title: "Monthly Summary",
          description:
            "Monthly collection trends and comparisons with previous months",
          icon: "fa-chart-line",
          color: "#4cc9f0",
        },
        {
          id: "student_ledger",
          title: "Student Ledger",
          description:
            "Complete fee history for individual students with balances",
          icon: "fa-user-graduate",
          color: "#7209b7",
        },
        {
          id: "category_wise",
          title: "Category-wise Report",
          description:
            "Analysis of collections by fee category (Tuition, Library, etc.)",
          icon: "fa-tags",
          color: "#f8961e",
        },
        {
          id: "outstanding_report",
          title: "Outstanding Balances",
          description: "List of students with pending fees and amount details",
          icon: "fa-exclamation-circle",
          color: "#f72585",
        },
        {
          id: "receipt_register",
          title: "Receipt Register",
          description:
            "Complete register of all issued receipts with payment details",
          icon: "fa-receipt",
          color: "#2a9d8f",
        },
        {
          id: "class_performance",
          title: "Class Performance",
          description: "Collection performance analysis by class/form",
          icon: "fa-chalkboard-teacher",
          color: "#4895ef",
        },
        {
          id: "payment_method",
          title: "Payment Method Analysis",
          description:
            "Analysis of payments by method (Cash, MPesa, Bank, etc.)",
          icon: "fa-credit-card",
          color: "#9d4edd",
        },
      ];

      let currentReportType = null;
      let currentReportData = null;

      function initializeReports() {
        loadReportTypes();
        loadFilterOptions();
      }

      function loadReportTypes() {
        const container = document.getElementById("reportTypes");
        const template = document.getElementById("reportCardTemplate");

        reportTypes.forEach((report) => {
          const card = template.content.cloneNode(true);
          const cardElement = card.querySelector(".report-card");

          cardElement.dataset.reportType = report.id;
          cardElement.querySelector(".report-icon i").className =
            `fas ${report.icon}`;
          cardElement.querySelector(".report-icon").style.color = report.color;
          cardElement.querySelector(".report-title").textContent = report.title;
          cardElement.querySelector(".report-desc").textContent =
            report.description;
          cardElement.querySelector(".last-generated").textContent =
            "Click to generate";

          container.appendChild(card);
        });
      }

      function loadFilterOptions() {
        // Load academic years
        fetch("/fees/reports/academic-years")
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              const select = document.getElementById("academicYear");
              data.years.forEach((year) => {
                const option = document.createElement("option");
                option.value = year;
                option.textContent = year;
                select.appendChild(option);
              });
            }
          });

        // Load fee categories
        fetch("/fees/categories/active")
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              const select = document.getElementById("feeCategory");
              data.categories.forEach((category) => {
                const option = document.createElement("option");
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);
              });
            }
          });

        // Load student classes
        fetch("/fees/reports/student-classes")
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              const select = document.getElementById("studentClass");
              data.classes.forEach((cls) => {
                const option = document.createElement("option");
                option.value = cls;
                option.textContent = cls;
                select.appendChild(option);
              });
            }
          });
      }

      function setupEventListeners() {
        // Report type selection
        document.addEventListener("click", function (e) {
          const card = e.target.closest(".report-card");
          if (card) {
            selectReportType(card.dataset.reportType);
          }
        });

        // Date range toggle
        document
          .getElementById("dateRange")
          .addEventListener("change", function () {
            const customRange = document.getElementById("customDateRange");
            customRange.style.display =
              this.value === "custom" ? "block" : "none";
          });

        // Generate report button
        document
          .getElementById("generateReportBtn")
          .addEventListener("click", generateReport);

        // Reset filters button
        document
          .getElementById("resetFiltersBtn")
          .addEventListener("click", resetFilters);

        // Adjust filters button
        document
          .getElementById("adjustFiltersBtn")
          .addEventListener("click", function () {
            document.getElementById("reportEmpty").style.display = "none";
            document
              .getElementById("filtersSection")
              .scrollIntoView({ behavior: "smooth" });
          });

        // Export all button
        document
          .getElementById("exportAllBtn")
          .addEventListener("click", exportAllReports);
      }

      function selectReportType(reportType) {
        currentReportType = reportType;

        // Update UI
        document.querySelectorAll(".report-card").forEach((card) => {
          card.classList.remove("active");
        });

        const selectedCard = document.querySelector(
          `[data-report-type="${reportType}"]`,
        );
        if (selectedCard) {
          selectedCard.classList.add("active");
        }

        // Show filters section
        document.getElementById("filtersSection").style.display = "block";

        // Scroll to filters
        setTimeout(() => {
          document
            .getElementById("filtersSection")
            .scrollIntoView({ behavior: "smooth" });
        }, 100);
      }

      function getFilterParams() {
        const params = {
          report_type: currentReportType,
          date_range: document.getElementById("dateRange").value,
          academic_year: document.getElementById("academicYear").value,
          term: document.getElementById("term").value,
          fee_category: document.getElementById("feeCategory").value,
          payment_status: document.getElementById("paymentStatus").value,
          payment_method: document.getElementById("paymentMethod").value,
          student_class: document.getElementById("studentClass").value,
          sort_by: document.getElementById("sortBy").value,
        };

        if (params.date_range === "custom") {
          params.start_date = document.getElementById("startDate").value;
          params.end_date = document.getElementById("endDate").value;

          if (!params.start_date || !params.end_date) {
            showAlert(
              "error",
              "Please select both start and end dates for custom range",
            );
            return null;
          }
        }

        return params;
      }

      function generateReport() {
        if (!currentReportType) {
          showAlert("error", "Please select a report type first");
          return;
        }

        const params = getFilterParams();
        if (!params) return;

        // Show loading state
        const resultsSection = document.getElementById("resultsSection");
        const reportLoading = document.getElementById("reportLoading");
        const reportContent = document.getElementById("reportContent");
        const reportEmpty = document.getElementById("reportEmpty");

        resultsSection.style.display = "block";
        reportLoading.style.display = "block";
        reportContent.style.display = "none";
        reportEmpty.style.display = "none";

        // Scroll to results
        resultsSection.scrollIntoView({ behavior: "smooth" });

        // Generate report
        fetch("/fees/reports/generate", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(params),
        })
          .then((response) => response.json())
          .then((data) => {
            reportLoading.style.display = "none";

            if (data.success) {
              currentReportData = data;
              displayReport(data);

              // Update total records
              document.getElementById("totalRecords").textContent =
                data.summary?.total_records || data.data?.length || 0;

              showAlert(
                "success",
                `Report generated successfully! Found ${data.summary?.total_records || 0} records.`,
              );
            } else {
              reportEmpty.style.display = "block";
              showAlert("error", data.message || "Failed to generate report");
            }
          })
          .catch((error) => {
            reportLoading.style.display = "none";
            reportEmpty.style.display = "block";
            showAlert("error", "Network error: " + error.message);
          });
      }

      function displayReport(data) {
        const container = document.getElementById("reportContent");
        container.innerHTML = "";

        // Show summary cards if available (COMPACT VERSION)
        if (data.summary) {
          const summaryHtml = `
                    <div class="summary-grid">
                        <div class="summary-card total">
                            <div class="summary-value">KSh ${formatNumber(data.summary.total_collected || 0)}</div>
                            <div class="summary-label">Total Collected</div>
                        </div>
                        <div class="summary-card paid">
                            <div class="summary-value">KSh ${formatNumber(data.summary.total_paid || 0)}</div>
                            <div class="summary-label">Total Paid</div>
                        </div>
                        <div class="summary-card balance">
                            <div class="summary-value">KSh ${formatNumber(data.summary.total_balance || 0)}</div>
                            <div class="summary-label">Total Balance</div>
                        </div>
                        <div class="summary-card count">
                            <div class="summary-value">${data.summary.total_records || 0}</div>
                            <div class="summary-label">Total Records</div>
                        </div>
                    </div>
                `;
          container.innerHTML += summaryHtml;
        }

        // Show charts if available (COMPACT VERSION)
        if (data.charts && data.charts.length > 0) {
          const chartsHtml = `
                    <div class="charts-grid">
                        ${data.charts
                          .map(
                            (chart, index) => `
                            <div class="chart-container">
                                <h4 class="chart-title">
                                    <i class="fas fa-chart-${chart.type === "pie" ? "pie" : "bar"}"></i>
                                    ${chart.title}
                                </h4>
                                <div class="chart-wrapper">
                                    <canvas id="chart-${index}"></canvas>
                                </div>
                            </div>
                        `,
                          )
                          .join("")}
                    </div>
                `;
          container.innerHTML += chartsHtml;

          // Render charts with compact options
          setTimeout(() => {
            data.charts.forEach((chart, index) => {
              renderCompactChart(`chart-${index}`, chart);
            });
          }, 100);
        }

        // Show data table if available
        if (data.data && data.data.length > 0) {
          const tableHtml = `
                    <div style="margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 class="section-title" style="font-size: 18px; margin-bottom: 0;">
                                <i class="fas fa-table"></i>
                                Report Data
                            </h3>
                            <div class="export-options">
                                <button class="btn btn-success btn-sm" onclick="exportReport('csv')">
                                    <i class="fas fa-file-csv"></i> CSV
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="exportReport('pdf')">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="exportReport('excel')">
                                    <i class="fas fa-file-excel"></i> Excel
                                </button>
                            </div>
                        </div>
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        ${Object.keys(data.data[0])
                                          .map(
                                            (key) =>
                                              `<th>${formatColumnName(key)}</th>`,
                                          )
                                          .join("")}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.data
                                      .map(
                                        (row) => `
                                        <tr>
                                            ${Object.values(row)
                                              .map(
                                                (value) => `
                                                <td>${formatCellValue(value)}</td>
                                            `,
                                              )
                                              .join("")}
                                        </tr>
                                    `,
                                      )
                                      .join("")}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
          container.innerHTML += tableHtml;
        }

        // Show export options (COMPACT VERSION)
        const exportHtml = `
                <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #eaeaea;">
                    <div class="export-options">
                        <button class="btn btn-primary btn-sm" onclick="printReport()">
                            <i class="fas fa-print"></i> Print
                        </button>
                        <button class="btn btn-success btn-sm" onclick="exportReport('csv')">
                            <i class="fas fa-file-csv"></i> CSV
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="exportReport('pdf')">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="saveReport()">
                            <i class="fas fa-save"></i> Save
                        </button>
                    </div>
                </div>
            `;
        container.innerHTML += exportHtml;

        container.style.display = "block";
      }

      function renderCompactChart(canvasId, chartData) {
        const canvas = document.getElementById(canvasId);
        const ctx = canvas.getContext("2d");

        // Set canvas size based on container
        const container = canvas.closest(".chart-wrapper");
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;

        // Compact chart options
        const compactOptions = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: "top",
              labels: {
                font: {
                  size: 11,
                },
                padding: 10,
                boxWidth: 12,
              },
            },
            tooltip: {
              bodyFont: {
                size: 11,
              },
              titleFont: {
                size: 11,
              },
              padding: 8,
              callbacks: {
                label: function (context) {
                  let label = context.dataset.label || "";
                  if (label) {
                    label += ": ";
                  }
                  label +=
                    "KSh " + formatNumber(context.parsed.y || context.parsed);
                  return label;
                },
              },
            },
          },
          scales: chartData.scales || {
            x: {
              ticks: {
                font: {
                  size: 10,
                },
                maxRotation: 45,
              },
              grid: {
                display: false,
              },
            },
            y: {
              beginAtZero: true,
              ticks: {
                font: {
                  size: 10,
                },
                callback: function (value) {
                  if (value >= 1000000) {
                    return "KSh " + (value / 1000000).toFixed(1) + "M";
                  } else if (value >= 1000) {
                    return "KSh " + (value / 1000).toFixed(1) + "K";
                  }
                  return "KSh " + value;
                },
                maxTicksLimit: 6,
              },
              grid: {
                color: "rgba(0,0,0,0.05)",
              },
            },
          },
          layout: {
            padding: {
              top: 10,
              bottom: 10,
              left: 10,
              right: 10,
            },
          },
        };

        // For pie/doughnut charts
        if (chartData.type === "pie" || chartData.type === "doughnut") {
          compactOptions.plugins.legend.position = "right";
          compactOptions.plugins.legend.labels.boxWidth = 10;
          compactOptions.plugins.legend.labels.padding = 5;
          delete compactOptions.scales;
        }

        const config = {
          type: chartData.type || "bar",
          data: {
            labels: chartData.labels || [],
            datasets: chartData.datasets || [],
          },
          options: compactOptions,
        };

        // Destroy existing chart if it exists
        if (canvas.chart) {
          canvas.chart.destroy();
        }

        // Create new chart
        canvas.chart = new Chart(ctx, config);

        // Handle window resize
        window.addEventListener("resize", function () {
          if (canvas.chart) {
            canvas.chart.resize();
          }
        });
      }

      function renderChart(canvasId, chartData) {
        renderCompactChart(canvasId, chartData); // Use the compact version
      }

      function resetFilters() {
        document.getElementById("dateRange").value = "today";
        document.getElementById("customDateRange").style.display = "none";
        document.getElementById("academicYear").value = "all";
        document.getElementById("term").value = "all";
        document.getElementById("feeCategory").value = "all";
        document.getElementById("paymentStatus").value = "all";
        document.getElementById("paymentMethod").value = "all";
        document.getElementById("studentClass").value = "all";
        document.getElementById("sortBy").value = "date_desc";

        document.getElementById("startDate").value = "";
        document.getElementById("endDate").value = "";
      }

      function exportReport(format) {
        if (!currentReportData) {
          showAlert("error", "No report data to export");
          return;
        }

        const params = getFilterParams();
        if (!params) return;

        params.export_format = format;

        // Create export URL
        const queryParams = new URLSearchParams(params).toString();
        window.open(`/fees/reports/export?${queryParams}`, "_blank");
      }

      function exportAllReports() {
        showAlert("info", "Exporting all reports... This may take a moment.");

        // In a real implementation, this would generate a comprehensive PDF/Excel
        // For now, we'll use the current filters
        exportReport("excel");
      }

      function printReport() {
        window.print();
      }

      function saveReport() {
        if (!currentReportData) {
          showAlert("error", "No report to save");
          return;
        }

        // In a real implementation, this would save to database
        showAlert(
          "success",
          "Report saved successfully! You can access it later from Saved Reports.",
        );
      }

      function formatNumber(num) {
        return parseInt(num || 0).toLocaleString("en-KE");
      }

      function formatColumnName(name) {
        return name
          .split("_")
          .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
          .join(" ");
      }

      function formatCellValue(value) {
        if (value === null || value === undefined) return "-";

        if (typeof value === "number") {
          if (value.toString().includes(".")) {
            return (
              "KSh " +
              parseFloat(value).toLocaleString("en-KE", {
                minimumFractionDigits: 2,
              })
            );
          }
          return "KSh " + parseInt(value).toLocaleString("en-KE");
        }

        if (typeof value === "string") {
          // Check if it's a date
          if (value.match(/^\d{4}-\d{2}-\d{2}/)) {
            return new Date(value).toLocaleDateString("en-GB");
          }

          // Check if it's a status
          if (value.toLowerCase() === "paid") {
            return `<span class="badge badge-success">PAID</span>`;
          }
          if (value.toLowerCase() === "partial") {
            return `<span class="badge badge-warning">PARTIAL</span>`;
          }
          if (value.toLowerCase() === "pending") {
            return `<span class="badge badge-danger">PENDING</span>`;
          }
        }

        return value;
      }

      function showAlert(type, message) {
        // Hide all alerts first
        ["success", "error", "warning", "info"].forEach((alertType) => {
          document.getElementById(`${alertType}Alert`).classList.remove("show");
        });

        const alertEl = document.getElementById(`${type}Alert`);
        const messageEl = document.getElementById(`${type}Message`);

        if (alertEl && messageEl) {
          messageEl.textContent = message;
          alertEl.classList.add("show");

          // Auto-hide after 5 seconds
          setTimeout(() => {
            alertEl.classList.remove("show");
          }, 5000);
        }
      }
    </script>
  </body>
</html>
