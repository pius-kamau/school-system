<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %> - Fee Management</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f7fa;
        color: #333;
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      header {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      h1 {
        color: #4361ee;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .subtitle {
        color: #666;
        margin-bottom: 20px;
      }

      .nav-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
        text-decoration: none;
        font-size: 0.9rem;
      }

      .btn-primary {
        background: #4361ee;
        color: white;
      }

      .btn-primary:hover {
        background: #3a0ca3;
        transform: translateY(-2px);
      }

      .btn-success {
        background: #28a745;
        color: white;
      }

      .btn-success:hover {
        background: #218838;
        transform: translateY(-2px);
      }

      .btn-warning {
        background: #ffc107;
        color: #212529;
      }

      .btn-warning:hover {
        background: #e0a800;
        transform: translateY(-2px);
      }

      .btn-danger {
        background: #dc3545;
        color: white;
      }

      .btn-danger:hover {
        background: #c82333;
        transform: translateY(-2px);
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
      }

      .card {
        background: white;
        border-radius: 10px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .card h2 {
        color: #4361ee;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .stat-card {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        border-left: 4px solid #4361ee;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #4361ee;
        margin-bottom: 5px;
      }

      .stat-label {
        color: #666;
        font-size: 0.9rem;
      }

      .backup-list {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 8px;
      }

      .backup-item {
        padding: 15px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .backup-item:last-child {
        border-bottom: none;
      }

      .backup-item:hover {
        background: #f8f9fa;
      }

      .backup-info h4 {
        margin-bottom: 5px;
        color: #333;
      }

      .backup-meta {
        display: flex;
        gap: 15px;
        font-size: 0.85rem;
        color: #666;
      }

      .backup-actions {
        display: flex;
        gap: 10px;
      }

      .btn-sm {
        padding: 6px 12px;
        font-size: 0.8rem;
      }

      .alert {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
      }

      .alert-success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }

      .alert-error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }

      .alert-warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
      }

      .alert-show {
        display: block;
        animation: fadeIn 0.3s;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .loading i {
        font-size: 2rem;
        margin-bottom: 10px;
        color: #4361ee;
      }

      .empty-state {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .empty-state i {
        font-size: 3rem;
        margin-bottom: 15px;
        color: #adb5bd;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal.show {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 10px;
        padding: 30px;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-header {
        margin-bottom: 20px;
      }

      .modal-header h3 {
        color: #4361ee;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .modal-body {
        margin-bottom: 20px;
      }

      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #495057;
      }

      .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 1rem;
      }

      .form-control:focus {
        outline: none;
        border-color: #4361ee;
        box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .progress-bar {
        width: 100%;
        height: 10px;
        background: #e9ecef;
        border-radius: 5px;
        overflow: hidden;
        margin-top: 10px;
      }

      .progress-fill {
        height: 100%;
        background: #4361ee;
        border-radius: 5px;
        transition: width 0.3s;
      }

      .backup-files {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 15px;
        margin-top: 15px;
      }

      .backup-file {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #dee2e6;
      }

      .backup-file:last-child {
        border-bottom: none;
      }
    </style>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
  </head>
  <body>
    <div class="container">
      <header>
        <h1><i class="fas fa-database"></i> <%= title %></h1>
        <p class="subtitle">
          Backup, restore, and manage your fee collection data
        </p>

        <div class="nav-buttons">
          <a href="/fees" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
          </a>
          <a href="/fees/reset" class="btn btn-danger">
            <i class="fas fa-trash-alt"></i> Reset Collections
          </a>
        </div>
      </header>

      <!-- Alerts -->
      <div id="successAlert" class="alert alert-success">
        <i class="fas fa-check-circle"></i> <span id="successMessage"></span>
      </div>

      <div id="errorAlert" class="alert alert-error">
        <i class="fas fa-exclamation-circle"></i>
        <span id="errorMessage"></span>
      </div>

      <div id="warningAlert" class="alert alert-warning">
        <i class="fas fa-exclamation-triangle"></i>
        <span id="warningMessage"></span>
      </div>

      <!-- Quick Actions -->
      <div class="card">
        <h2><i class="fas fa-bolt"></i> Quick Actions</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalBackups">0</div>
            <div class="stat-label">Total Backups</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="dbSize">0 KB</div>
            <div class="stat-label">Database Size</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="diskFree">0%</div>
            <div class="stat-label">Disk Space Free</div>
          </div>
        </div>

        <div style="display: flex; gap: 10px; flex-wrap: wrap">
          <button id="createBackupBtn" class="btn btn-success">
            <i class="fas fa-plus-circle"></i> Create New Backup
          </button>
          <button id="refreshBtn" class="btn btn-primary">
            <i class="fas fa-sync-alt"></i> Refresh List
          </button>
          <button id="cleanupBtn" class="btn btn-warning">
            <i class="fas fa-broom"></i> Cleanup Old Backups
          </button>
        </div>
      </div>

      <!-- Available Backups -->
      <div class="card">
        <h2><i class="fas fa-history"></i> Available Backups</h2>

        <div id="backupsList" class="backup-list">
          <div class="loading" id="loadingBackups">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading backups...</p>
          </div>
        </div>
      </div>

      <!-- Backup Instructions -->
      <div class="card">
        <h2><i class="fas fa-info-circle"></i> Backup Information</h2>
        <div
          style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
          "
        >
          <div>
            <h4 style="color: #4361ee; margin-bottom: 10px">
              <i class="fas fa-shield-alt"></i> Why Backup?
            </h4>
            <ul style="color: #666; line-height: 1.8; padding-left: 20px">
              <li>Protect against data loss</li>
              <li>Recover from accidental deletions</li>
              <li>Maintain historical records</li>
              <li>Prepare for system resets</li>
            </ul>
          </div>
          <div>
            <h4 style="color: #4361ee; margin-bottom: 10px">
              <i class="fas fa-lightbulb"></i> Best Practices
            </h4>
            <ul style="color: #666; line-height: 1.8; padding-left: 20px">
              <li>Create backups before major changes</li>
              <li>Store backups in multiple locations</li>
              <li>Regularly test backup restoration</li>
              <li>Keep at least 3 recent backups</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Create Backup Modal -->
    <div id="createBackupModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-plus-circle"></i> Create New Backup</h3>
        </div>
        <div class="modal-body">
          <p style="margin-bottom: 15px; color: #666">
            This will create a comprehensive backup of all fee collection data.
          </p>

          <div class="form-group">
            <label>Backup Types:</label>
            <div class="backup-files">
              <div class="backup-file">
                <span>Full Database Copy (.sqlite)</span>
                <span style="color: #28a745"
                  ><i class="fas fa-check"></i> Included</span
                >
              </div>
              <div class="backup-file">
                <span>SQL Dump (.sql)</span>
                <span style="color: #28a745"
                  ><i class="fas fa-check"></i> Included</span
                >
              </div>
              <div class="backup-file">
                <span>JSON Data (.json)</span>
                <span style="color: #28a745"
                  ><i class="fas fa-check"></i> Included</span
                >
              </div>
              <div class="backup-file">
                <span>CSV Files (.csv)</span>
                <span style="color: #28a745"
                  ><i class="fas fa-check"></i> Included</span
                >
              </div>
            </div>
          </div>

          <div class="progress-bar">
            <div
              id="backupProgress"
              class="progress-fill"
              style="width: 0%"
            ></div>
          </div>
          <div
            id="backupStatus"
            style="text-align: center; margin-top: 10px; color: #666"
          ></div>

          <div id="backupResult" style="display: none"></div>
        </div>
        <div class="modal-footer">
          <button id="startBackupBtn" class="btn btn-success">
            <i class="fas fa-play"></i> Start Backup
          </button>
          <button id="cancelBackupBtn" class="btn btn-secondary">
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Restore Modal -->
    <div id="restoreModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3><i class="fas fa-undo"></i> Restore from Backup</h3>
        </div>
        <div class="modal-body">
          <p style="margin-bottom: 15px; color: #dc3545">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Warning:</strong> This will overwrite current data. A safety
            backup will be created automatically.
          </p>

          <div class="form-group">
            <label>Select Backup File:</label>
            <select id="restoreFileSelect" class="form-control">
              <option value="">Select a backup file...</option>
            </select>
          </div>

          <div class="form-group">
            <div class="checkbox-group">
              <input
                type="checkbox"
                id="confirmRestore"
                name="confirmRestore"
              />
              <label for="confirmRestore"
                >I understand this will overwrite current data</label
              >
            </div>
          </div>

          <div
            id="restoreStatus"
            style="text-align: center; margin-top: 10px; color: #666"
          ></div>
        </div>
        <div class="modal-footer">
          <button id="confirmRestoreBtn" class="btn btn-danger" disabled>
            <i class="fas fa-undo"></i> Confirm Restore
          </button>
          <button id="cancelRestoreBtn" class="btn btn-secondary">
            <i class="fas fa-times"></i> Cancel
          </button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        loadBackups();
        setupEventListeners();
      });

      function loadBackups() {
        const loadingEl = document.getElementById("loadingBackups");
        const backupsList = document.getElementById("backupsList");

        fetch("/fees/backup/list")
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              displayBackups(data.backups);
              updateStats(data);
            } else {
              showEmptyState("Failed to load backups");
            }
          })
          .catch((error) => {
            console.error("Error loading backups:", error);
            showEmptyState("Error loading backups");
          })
          .finally(() => {
            loadingEl.style.display = "none";
          });
      }

      function displayBackups(backups) {
        const backupsList = document.getElementById("backupsList");

        if (!backups || backups.length === 0) {
          showEmptyState("No backups found. Create your first backup!");
          return;
        }

        backupsList.innerHTML = "";

        backups.forEach((backupGroup) => {
          const backupEl = document.createElement("div");
          backupEl.className = "backup-item";

          backupEl.innerHTML = `
                    <div class="backup-info">
                        <h4>Backup: ${backupGroup.date}</h4>
                        <div class="backup-meta">
                            <span><i class="far fa-clock"></i> ${backupGroup.timestamp}</span>
                            <span><i class="far fa-file"></i> ${backupGroup.files.length} files</span>
                        </div>
                        <div class="backup-files" style="margin-top: 10px;">
                            ${backupGroup.files
                              .map(
                                (file) => `
                                <div class="backup-file">
                                    <span>${file.name}</span>
                                    <span>${file.size}</span>
                                </div>
                            `,
                              )
                              .join("")}
                        </div>
                    </div>
                    <div class="backup-actions">
                        ${
                          backupGroup.files.find((f) => f.type === "Database")
                            ? `<button class="btn btn-primary btn-sm" onclick="restoreBackup('${backupGroup.files.find((f) => f.type === "Database").name}')">
                                <i class="fas fa-undo"></i> Restore
                            </button>`
                            : ""
                        }
                        ${
                          backupGroup.files.find((f) => f.type === "Database")
                            ? `<button class="btn btn-success btn-sm" onclick="downloadBackup('${backupGroup.files.find((f) => f.type === "Database").name}')">
                                <i class="fas fa-download"></i> Download
                            </button>`
                            : ""
                        }
                        <button class="btn btn-danger btn-sm" onclick="deleteBackup('${backupGroup.timestamp}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;

          backupsList.appendChild(backupEl);
        });
      }

      function showEmptyState(message) {
        const backupsList = document.getElementById("backupsList");
        backupsList.innerHTML = `
                <div class="empty-state">
                    <i class="far fa-folder-open"></i>
                    <h3>No Backups Yet</h3>
                    <p>${message}</p>
                    <button id="createFirstBackupBtn" class="btn btn-success" style="margin-top: 15px;">
                        <i class="fas fa-plus-circle"></i> Create First Backup
                    </button>
                </div>
            `;

        document
          .getElementById("createFirstBackupBtn")
          ?.addEventListener("click", showCreateBackupModal);
      }

      function updateStats(data) {
        document.getElementById("totalBackups").textContent = data.count || 0;

        if (data.disk_info) {
          document.getElementById("diskFree").textContent =
            `${(100 - parseFloat(data.disk_info.used_percentage)).toFixed(0)}%`;
        }
      }

      function setupEventListeners() {
        // Create Backup Button
        document
          .getElementById("createBackupBtn")
          .addEventListener("click", showCreateBackupModal);

        // Refresh Button
        document
          .getElementById("refreshBtn")
          .addEventListener("click", loadBackups);

        // Cleanup Button
        document
          .getElementById("cleanupBtn")
          .addEventListener("click", cleanupBackups);

        // Modal buttons
        document
          .getElementById("cancelBackupBtn")
          .addEventListener("click", hideCreateBackupModal);
        document
          .getElementById("cancelRestoreBtn")
          .addEventListener("click", hideRestoreModal);

        // Start Backup Button
        document
          .getElementById("startBackupBtn")
          .addEventListener("click", startBackup);

        // Restore confirmation
        document
          .getElementById("confirmRestore")
          .addEventListener("change", function () {
            document.getElementById("confirmRestoreBtn").disabled =
              !this.checked;
          });

        // Confirm Restore Button
        document
          .getElementById("confirmRestoreBtn")
          .addEventListener("click", confirmRestore);

        // Restore file selection
        document
          .getElementById("restoreFileSelect")
          .addEventListener("change", function () {
            document.getElementById("confirmRestoreBtn").disabled = !this.value;
          });
      }

      function showCreateBackupModal() {
        document.getElementById("createBackupModal").classList.add("show");
        resetBackupUI();
      }

      function hideCreateBackupModal() {
        document.getElementById("createBackupModal").classList.remove("show");
      }

      function resetBackupUI() {
        document.getElementById("backupProgress").style.width = "0%";
        document.getElementById("backupStatus").textContent = "";
        document.getElementById("backupResult").style.display = "none";
        document.getElementById("backupResult").innerHTML = "";
        document.getElementById("startBackupBtn").disabled = false;
      }

      function startBackup() {
        const startBtn = document.getElementById("startBackupBtn");
        const statusEl = document.getElementById("backupStatus");
        const progressEl = document.getElementById("backupProgress");
        const resultEl = document.getElementById("backupResult");

        startBtn.disabled = true;
        startBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Creating...';
        statusEl.textContent = "Starting backup...";
        progressEl.style.width = "10%";

        // Simulate progress updates
        const progressInterval = setInterval(() => {
          const currentWidth = parseInt(progressEl.style.width);
          if (currentWidth < 90) {
            progressEl.style.width = currentWidth + 10 + "%";
          }
        }, 500);

        fetch("/fees/backup/create")
          .then((response) => response.json())
          .then((data) => {
            clearInterval(progressInterval);

            if (data.success) {
              progressEl.style.width = "100%";
              statusEl.textContent = "Backup completed successfully!";

              resultEl.style.display = "block";
              resultEl.innerHTML = `
                            <div class="backup-files">
                                <h4>Created Backup Files:</h4>
                                ${data.backups
                                  .map(
                                    (backup) => `
                                    <div class="backup-file">
                                        <span>${backup.type}</span>
                                        <span>${backup.size}</span>
                                    </div>
                                `,
                                  )
                                  .join("")}
                            </div>
                        `;

              showAlert("success", data.message);

              // Reload backups list after a delay
              setTimeout(loadBackups, 2000);

              // Close modal after 3 seconds
              setTimeout(() => {
                hideCreateBackupModal();
              }, 3000);
            } else {
              progressEl.style.width = "0%";
              statusEl.textContent = "Backup failed";
              showAlert("error", data.message || "Backup failed");
            }
          })
          .catch((error) => {
            clearInterval(progressInterval);
            progressEl.style.width = "0%";
            statusEl.textContent = "Backup failed";
            showAlert("error", "Network error: " + error.message);
          })
          .finally(() => {
            startBtn.disabled = false;
            startBtn.innerHTML = '<i class="fas fa-play"></i> Start Backup';
          });
      }

      function showRestoreModal() {
        // Populate file select
        const selectEl = document.getElementById("restoreFileSelect");
        selectEl.innerHTML =
          '<option value="">Select a backup file...</option>';

        fetch("/fees/backup/list")
          .then((response) => response.json())
          .then((data) => {
            if (data.success && data.backups) {
              data.backups.forEach((backupGroup) => {
                backupGroup.files.forEach((file) => {
                  if (file.type === "Database") {
                    const option = document.createElement("option");
                    option.value = file.name;
                    option.textContent = `${backupGroup.date} - ${file.name} (${file.size})`;
                    selectEl.appendChild(option);
                  }
                });
              });
            }
          });

        document.getElementById("restoreModal").classList.add("show");
        document.getElementById("confirmRestore").checked = false;
        document.getElementById("confirmRestoreBtn").disabled = true;
      }

      function hideRestoreModal() {
        document.getElementById("restoreModal").classList.remove("show");
      }

      function restoreBackup(filename) {
        showRestoreModal();
        document.getElementById("restoreFileSelect").value = filename;
        document.getElementById("confirmRestoreBtn").disabled = false;
      }

      function confirmRestore() {
        const filename = document.getElementById("restoreFileSelect").value;
        const statusEl = document.getElementById("restoreStatus");
        const confirmBtn = document.getElementById("confirmRestoreBtn");

        if (!filename) {
          showAlert("error", "Please select a backup file");
          return;
        }

        confirmBtn.disabled = true;
        confirmBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Restoring...';
        statusEl.textContent = "Restoring backup...";

        fetch("/fees/backup/restore", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ backup_file: filename }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              statusEl.innerHTML = `
                        <span style="color: #28a745;">
                            <i class="fas fa-check-circle"></i> ${data.message}
                        </span>
                        <div style="margin-top: 10px; font-size: 0.9rem;">
                            Safety backup created: ${data.safety_backup}
                        </div>
                    `;

              showAlert("success", data.message);

              // Close modal after 3 seconds
              setTimeout(() => {
                hideRestoreModal();
                // Refresh page to show restored data
                window.location.reload();
              }, 3000);
            } else {
              statusEl.innerHTML = `
                        <span style="color: #dc3545;">
                            <i class="fas fa-exclamation-circle"></i> ${data.message}
                        </span>
                    `;
              showAlert("error", data.message);
              confirmBtn.disabled = false;
              confirmBtn.innerHTML =
                '<i class="fas fa-undo"></i> Confirm Restore';
            }
          })
          .catch((error) => {
            statusEl.innerHTML = `
                    <span style="color: #dc3545;">
                        <i class="fas fa-exclamation-circle"></i> Restore failed: ${error.message}
                    </span>
                `;
            showAlert("error", "Restore failed: " + error.message);
            confirmBtn.disabled = false;
            confirmBtn.innerHTML =
              '<i class="fas fa-undo"></i> Confirm Restore';
          });
      }

      function downloadBackup(filename) {
        window.open(
          `/fees/backup/download/${encodeURIComponent(filename)}`,
          "_blank",
        );
      }

      function deleteBackup(timestamp) {
        if (
          !confirm(`Are you sure you want to delete backup from ${timestamp}?`)
        ) {
          return;
        }

        // Find and delete all files with this timestamp
        fetch("/fees/backup/list")
          .then((response) => response.json())
          .then((data) => {
            if (data.success && data.backups) {
              const backupGroup = data.backups.find(
                (b) => b.timestamp === timestamp,
              );
              if (backupGroup) {
                // Delete each file in the backup group
                const deletePromises = backupGroup.files.map((file) =>
                  fetch(
                    `/fees/backup/delete/${encodeURIComponent(file.name)}`,
                    {
                      method: "DELETE",
                    },
                  ),
                );

                Promise.all(deletePromises)
                  .then(() => {
                    showAlert(
                      "success",
                      `Backup from ${timestamp} deleted successfully`,
                    );
                    loadBackups();
                  })
                  .catch((error) => {
                    showAlert(
                      "error",
                      "Failed to delete backup: " + error.message,
                    );
                  });
              }
            }
          });
      }

      function cleanupBackups() {
        if (
          !confirm(
            "This will delete all backups except the 3 most recent ones. Continue?",
          )
        ) {
          return;
        }

        fetch("/fees/backup/list")
          .then((response) => response.json())
          .then((data) => {
            if (data.success && data.backups && data.backups.length > 3) {
              const backupsToDelete = data.backups.slice(3);
              const deleteCount = backupsToDelete.length;

              if (deleteCount === 0) {
                showAlert("info", "No old backups to clean up");
                return;
              }

              if (!confirm(`Delete ${deleteCount} old backup(s)?`)) {
                return;
              }

              // Delete all old backups
              const deletePromises = backupsToDelete.flatMap((backup) =>
                backup.files.map((file) =>
                  fetch(
                    `/fees/backup/delete/${encodeURIComponent(file.name)}`,
                    {
                      method: "DELETE",
                    },
                  ),
                ),
              );

              Promise.all(deletePromises)
                .then(() => {
                  showAlert(
                    "success",
                    `Cleaned up ${deleteCount} old backup(s)`,
                  );
                  loadBackups();
                })
                .catch((error) => {
                  showAlert("error", "Cleanup failed: " + error.message);
                });
            } else {
              showAlert("info", "No old backups to clean up");
            }
          });
      }

      function showAlert(type, message) {
        // Hide all alerts first
        ["success", "error", "warning"].forEach((alertType) => {
          document
            .getElementById(`${alertType}Alert`)
            .classList.remove("alert-show");
        });

        const alertEl = document.getElementById(`${type}Alert`);
        const messageEl = document.getElementById(`${type}Message`);

        messageEl.textContent = message;
        alertEl.classList.add("alert-show");

        // Auto-hide after 5 seconds
        setTimeout(() => {
          alertEl.classList.remove("alert-show");
        }, 5000);
      }
    </script>
  </body>
</html>
